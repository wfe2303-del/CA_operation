<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>í´ë˜ìŠ¤ì–´ë¼ìš´ë“œ Â· ì¹´ì¹´ì˜¤í†¡ ì…ì¥ì ì²´í¬ë´‡ (Dual)</title>
  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --surface:#f8fafc;
      --line:#e5e7eb;
      --text:#0f172a;
      --muted:#64748b;
      --accent:#2563eb;         /* íŒŒë‘ */
      --accent-soft:#dbeafe;
      --accent-strong:#1d4ed8;
      --ok:#16a34a;             /* ì´ˆë¡ */
      --warn:#ea580c;           /* ì£¼í™© */
      --bad:#ef4444;            /* ë¹¨ê°• */
      --radius:12px;
      --ctl-h:42px;
      --gap:12px;
      --logo-size:112px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    }
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    h1{font-size:22px;margin:0 0 8px}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:16px;
      padding:16px;
      margin-bottom:16px;
      box-shadow:0 6px 16px rgba(15,23,42,0.04);
    }
    label{display:block;color:var(--muted);margin-bottom:6px}

    select,input[type="file"],input[type="text"]{
      width:100%;
      background:#fff;
      color:var(--text);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:9px 10px;
      outline:none;
      height:var(--ctl-h);
      font-size:13px;
    }

    .btn{
      appearance:none;
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      padding:10px 14px;
      border-radius:var(--radius);
      cursor:pointer;
      transition:all .15s ease;
      height:var(--ctl-h);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:13px;
      gap:6px;
      white-space:nowrap;
    }
    .btn:hover{
      border-color:var(--accent-strong);
      box-shadow:0 0 0 3px rgba(37,99,235,.18);
    }
    .btn.acc{
      background:var(--accent);
      border-color:var(--accent);
      color:#fff;
    }
    .btn.acc:hover{
      background:var(--accent-strong);
      border-color:var(--accent-strong);
    }
    .btn.outline-blue{
      border-color:var(--accent);
      color:var(--accent-strong);
      background:var(--accent-soft);
    }
    .btn.outline-blue:hover{
      background:#bfdbfe;
    }
    .btn.sm{
      height:32px;
      padding:4px 10px;
      border-radius:10px;
      font-size:12px;
    }

    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .hint{color:#64748b;font-size:12px}
    .err{color:#ef4444;font-family:ui-monospace,monospace;white-space:pre-wrap;font-size:12px}

    .pill{
      display:inline-flex;
      gap:6px;
      align-items:center;
      padding:5px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      color:var(--muted);
      background:#fff;
      font-size:11px;
    }
    .pill.ok{border-color:rgba(22,163,74,.25);color:var(--ok);background:#f0fdf4}
    .pill.warn{border-color:rgba(234,88,12,.25);color:var(--warn);background:#fff7ed}
    .pill.bad{border-color:rgba(239,68,68,.25);color:var(--bad);background:#fef2f2}

    table{
      width:100%;
      border-collapse:collapse;
      border:1px solid var(--line);
      background:#fff;
      border-radius:12px;
      overflow:hidden;
    }
    th,td{
      padding:8px 10px;
      border-bottom:1px solid var(--line);
      text-align:left;
      vertical-align:top;
      font-size:12px;
    }
    th{
      color:#0f172a;
      font-weight:600;
      background:#f1f5f9;
      position:sticky;
      top:0;
      z-index:1;
    }

    .brand{display:flex;align-items:center;gap:14px;margin:0 0 6px}
    .brand h1{margin:0;font-size:22px}
    .brand-logo{width:var(--logo-size);height:var(--logo-size);flex:0 0 var(--logo-size)}
    .logo-text{
      font-family:'Nunito','Arial Rounded MT','SF Pro Rounded','Quicksand','Pretendard','Noto Sans KR',sans-serif;
      font-weight:900; letter-spacing:-0.2px; fill:#0f172a; font-size:18px;
      paint-order:stroke fill; stroke:#0f172a; stroke-width:.9px;
    }

    .subhead{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
    }
    .auth-pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      font-size:11px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--muted);
    }
    .auth-pill.ok{
      border-color:rgba(37,99,235,.32);
      background:#eff6ff;
      color:#1d4ed8;
    }
    .auth-pill.bad{
      border-color:rgba(239,68,68,.32);
      background:#fef2f2;
      color:#b91c1c;
    }

    .panels{display:grid;gap:16px}
    @media(min-width:1100px){ .panels{grid-template-columns:1fr 1fr} }

    .controls{display:grid;gap:var(--gap)}
    .controls-line{
      display:grid;
      align-items:end;
      gap:var(--gap);
      grid-template-columns:1.4fr 1.1fr auto;
    }

    .file-block{
      display:grid;
      gap:8px;
      margin-top:8px;
      padding:10px;
      border-radius:12px;
      background:#f9fafb;
      border:1px dashed #e5e7eb;
    }
    .file-row{
      display:grid;
      gap:6px;
      grid-template-columns:minmax(0,1.4fr) minmax(0,1.4fr);
      align-items:center;
    }
    .file-row > div:first-child{min-width:0}
    .file-row > div:last-child{min-width:0}
    .file-name{
      font-size:11px;
      color:#6b7280;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .drive-row-top{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:flex-start;
      flex-wrap:wrap;
    }
    .drive-label{
      font-size:11px;
      color:#6b7280;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .drive-label.connected{
      color:#1d4ed8;
      font-weight:600;
    }

    .results-wrap{display:grid;gap:16px;margin-top:8px}
    .table-scroll{max-height:260px;overflow:auto}

    .top-link{
      font-size:11px;
      color:#1d4ed8;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .top-link:hover{text-decoration:underline}

    .sheet-add-row{
      display:grid;
      gap:8px;
      grid-template-columns:minmax(0,1.8fr) auto;
      margin-top:10px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="brand">
      <svg class="brand-logo" viewBox="0 0 90 50" role="img" aria-label="ClassAround">
        <rect width="90" height="50" rx="10" fill="white"/>
        <circle cx="66" cy="10" r="8" fill="#2563eb"/>
        <circle cx="80" cy="18" r="5" fill="#ef4444"/>
        <text x="8" y="24" class="logo-text">Class</text>
        <text x="8" y="42" class="logo-text">Around</text>
      </svg>
      <div>
        <h1>ì¹´ì¹´ì˜¤í†¡ ì…ì¥ì ì²´í¬ë´‡</h1>
        <div class="subhead">
          <span class="hint">
          </span>
          <div class="row" style="gap:6px">
            <span id="globalAuthState" class="auth-pill">
              Google ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ì¤‘...
            </span>
            <a
              href="https://drive.google.com/drive/folders/1t33dy_UQCfsvoEQ9yOctIxvoT623i-j4?usp=drive_link"
              target="_blank"
              class="top-link"
            >
              ğŸ”— ê°•ì‚¬ ê³µìœ ìš© ì‹œíŠ¸ í´ë” ì—´ê¸°
            </a>
          </div>
        </div>
      </div>
    </header>

    <!-- ì‹œíŠ¸ / ì†ŒìŠ¤ ì•ˆë‚´ ì¹´ë“œ -->
    <div class="card" style="margin-bottom:18px">
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div class="hint">
          â‘  <b>ê°•ì‚¬ ê³µìœ ìš© ì‹œíŠ¸ í´ë”</b> ì•ˆì˜ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì„ íƒ<br />
          â‘¡ í•„ìš”í•˜ë©´ <b>ê°œë³„ êµ¬ê¸€ ì‹œíŠ¸ ID/URL</b>ë¡œ ì¶”ê°€<br />
          â‘¢ ì¹´ì¹´ì˜¤í†¡ ë‚´ë³´ë‚´ê¸° txt/csvëŠ”
          <b>ë¡œì»¬ ì—…ë¡œë“œ or ë“œë¼ì´ë¸Œ í´ë”</b>ì—ì„œ ì„ íƒ
        </div>
        <div style="text-align:right;min-width:220px">
          <button id="btnReloadSheets" type="button" class="btn outline-blue">
            ğŸ”„ ì‹œíŠ¸ ëª©ë¡ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
          </button>
          <div class="sheet-add-row">
            <input id="manualSheetInput" type="text"
              placeholder="ìŠ¤í”„ë ˆë“œì‹œíŠ¸ URL ë˜ëŠ” ID" />
            <button id="btnAddManualSheet" type="button" class="btn sm">
              + IDë¡œ ì¶”ê°€
            </button>
          </div>
        </div>
      </div>
      <div id="globalErr" class="err" style="margin-top:6px"></div>
    </div>

    <div class="panels">
      <!-- Panel A -->
      <section>
        <div class="card">
          <h3 style="margin:0 0 10px;font-size:15px">íŒ¨ë„ A Â· ì˜ˆ: 1ë²ˆë°©</h3>
          <div class="controls">
            <div class="controls-line">
              <div>
                <label>ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì„ íƒ</label>
                <select id="sheetSelectA"></select>
              </div>
              <div>
                <label>ì½ê¸° ì‹œíŠ¸ ì„ íƒ</label>
                <select id="readSheetSelectA"></select>
              </div>
              <div>
                <label style="visibility:hidden">sheet</label>
                <button id="btnOpenSheetA" class="btn outline-blue" type="button" disabled>
                  ìƒˆ íƒ­
                </button>
              </div>
            </div>

            <!-- ì¹´í†¡ ë¡œê·¸ ì†ŒìŠ¤: ë¡œì»¬ + ë“œë¼ì´ë¸Œ -->
            <div class="file-block">
              <div class="file-row">
                <div>
                  <label>ì¹´ì¹´ì˜¤í†¡ ì…ì¥ ë¡œê·¸ (ë¡œì»¬ txt / csv)</label>
                  <input id="chatFileA" type="file" accept=".txt,.csv,text/plain,text/csv" />
                </div>
                <div>
                  <span id="chatFileNameA" class="file-name">ì„ íƒëœ íŒŒì¼ ì—†ìŒ</span>
                  <div class="hint" style="margin-top:2px">
                  </div>
                </div>
              </div>

              <div class="file-row">
                <div>
                  <label>ì¹´ì¹´ì˜¤í†¡ ì…ì¥ ë¡œê·¸ (êµ¬ê¸€ ë“œë¼ì´ë¸Œ)</label>
                  <div class="drive-row-top">
                    <button id="btnDriveFolderA" type="button" class="btn sm">
                      ğŸ“ í´ë” ì—°ê²°
                    </button>
                    <span id="driveFolderLabelA" class="drive-label">í´ë” ë¯¸ì„¤ì •</span>
                    <button id="btnDriveRefreshA" type="button" class="btn sm">
                      ğŸ”„
                    </button>
                  </div>
                </div>
                <div>
                  <label style="visibility:hidden">íŒŒì¼ ì„ íƒ</label>
                  <select id="driveFileSelectA"></select>
                  <div class="hint" style="margin-top:2px">
                    txt / csv íŒŒì¼ ëª©ë¡
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <label class="row" style="gap:6px;align-items:center">
              <input id="previewOnlyA" type="checkbox" />
              <span class="hint">ì²´í¬ë§Œ</span>
            </label>
            <button id="runBtnA" class="btn acc" type="button">ì‹¤í–‰</button>
            <button id="demoBtnA" class="btn" type="button">ë°ëª¨</button>
            <span id="pillsAA" class="row"></span>
          </div>
          <div id="errA" class="err" style="margin-top:8px"></div>
        </div>
        <div id="resultsA" class="results-wrap"></div>
      </section>

      <!-- Panel B -->
      <section>
        <div class="card">
          <h3 style="margin:0 0 10px;font-size:15px">íŒ¨ë„ B Â· ì˜ˆ: 2ë²ˆë°©</h3>
          <div class="controls">
            <div class="controls-line">
              <div>
                <label>ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì„ íƒ</label>
                <select id="sheetSelectB"></select>
              </div>
              <div>
                <label>ì½ê¸° ì‹œíŠ¸ ì„ íƒ</label>
                <select id="readSheetSelectB"></select>
              </div>
              <div>
                <label style="visibility:hidden">sheet</label>
                <button id="btnOpenSheetB" class="btn outline-blue" type="button" disabled>
                  ìƒˆ íƒ­
                </button>
              </div>
            </div>

            <div class="file-block">
              <div class="file-row">
                <div>
                  <label>ì¹´ì¹´ì˜¤í†¡ ì…ì¥ ë¡œê·¸ (ë¡œì»¬ txt / csv)</label>
                  <input id="chatFileB" type="file" accept=".txt,.csv,text/plain,text/csv" />
                </div>
                <div>
                  <span id="chatFileNameB" class="file-name">ì„ íƒëœ íŒŒì¼ ì—†ìŒ</span>
                  <div class="hint" style="margin-top:2px">
                  </div>
                </div>
              </div>

              <div class="file-row">
                <div>
                  <label>ì¹´ì¹´ì˜¤í†¡ ì…ì¥ ë¡œê·¸ (êµ¬ê¸€ ë“œë¼ì´ë¸Œ)</label>
                  <div class="drive-row-top">
                    <button id="btnDriveFolderB" type="button" class="btn sm">
                      ğŸ“ í´ë” ì—°ê²°
                    </button>
                    <span id="driveFolderLabelB" class="drive-label">í´ë” ë¯¸ì„¤ì •</span>
                    <button id="btnDriveRefreshB" type="button" class="btn sm">
                      ğŸ”„
                    </button>
                  </div>
                </div>
                <div>
                  <label style="visibility:hidden">íŒŒì¼ ì„ íƒ</label>
                  <select id="driveFileSelectB"></select>
                  <div class="hint" style="margin-top:2px">
                    txt / csv íŒŒì¼ ëª©ë¡
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <label class="row" style="gap:6px;align-items:center">
              <input id="previewOnlyB" type="checkbox" />
              <span class="hint">ì²´í¬ë§Œ</span>
            </label>
            <button id="runBtnB" class="btn acc" type="button">ì‹¤í–‰</button>
            <button id="demoBtnB" class="btn" type="button">ë°ëª¨</button>
            <span id="pillsBB" class="row"></span>
          </div>
          <div id="errB" class="err" style="margin-top:8px"></div>
        </div>
        <div id="resultsB" class="results-wrap"></div>
      </section>
    </div>
  </div>

<script>
/* ========= ê³µí†µ ìœ í‹¸ ========= */
const PANEL_SUFFIXES = ['A','B'];
const $$ = id => document.getElementById(id);
const byPanel = (base,sfx) => $$(base + sfx);
const txt = (id,v,sfx) => {
  const el = sfx ? byPanel(id,sfx) : $$(id);
  if(el) el.textContent = v || '';
};
const val = (id,sfx) => {
  const el = sfx ? byPanel(id,sfx) : $$(id);
  return el ? el.value : '';
};
function on(id,ev,fn,sfx){
  const el = sfx ? byPanel(id,sfx) : $$(id);
  if(!el){ console.warn('bind skip',id,sfx); return; }
  el.addEventListener(ev,e => { try{ fn(e); } catch(err){ console.error(err); } });
}
function digitsOnly(s){return String(s||'').replace(/[^\d]/g,'');}
function last4Digits(s){const d=digitsOnly(s);return d.slice(-4);}
function normalizeName(n){
  let s = String(n||'').trim();
  s = s.replace(/[\s]*[\(\[\{ï¼ˆã€][^)\]\}ï¼‰ã€‘]*[\)\]\}ï¼‰ã€‘]\s*$/,'');
  s = s.replace(/[/_\-\s]+$/,'');
  s = s.replace(/\s+/g,' ');
  return s;
}
const earlierId = (a,b) => {
  const ai=parseInt(a,10), bi=parseInt(b,10);
  if(!Number.isNaN(ai) && !Number.isNaN(bi)) return ai<=bi?a:b;
  return (String(a)<=String(b))?a:b;
};

/* ========= ì „ì—­ ì—ëŸ¬ í•¸ë“¤ ========= */
(function(){
  const pushErr = (msg,src,l,c,e)=>{
    const details = (e && e.stack) ? '\n'+e.stack : '';
    txt('globalErr', msg + (src?` (${src}:${l}:${c})`:''));
    PANEL_SUFFIXES.forEach(s=>{
      const el = $$('err'+s);
      if(el) el.textContent = 'ì˜¤ë¥˜: '+msg+(src?`\n${src}:${l}:${c}`:'')+details;
    });
  };
  window.addEventListener('error',e=>pushErr(e.message,e.filename,e.lineno,e.colno,e.error));
  window.addEventListener('unhandledrejection',e=>{
    const r=e.reason||{};
    pushErr(r.message||String(r),'',0,0,r);
  });
})();

/* ========= ì„¤ì • ========= */
const READ_START_ROW   = 2;
const WRITE_START_ROW  = 2;
const FIXED_WRITE_SHEET = 'ê³µìœ ìš© ì‹œíŠ¸';
const READ_NAME_COL    = 'D'; // ì½ê¸° ì‹œíŠ¸ì—ì„œ ì´ë¦„ ì—´ (í•„ìš”ì‹œ ì—¬ê¸°ë§Œ ë³€ê²½)

/* ê°•ì‚¬ ê³µìœ ìš© ì‹œíŠ¸ í´ë” ID (ê³ ì •) */
const TEACHER_FOLDER_ID = '1t33dy_UQCfsvoEQ9yOctIxvoT623i-j4';

/* ========= í† í° / ì¸ì¦ (indexì—ì„œ ë¡œê·¸ì¸í•œ í† í° ì¬ì‚¬ìš©) ========= */
const TOKEN_KEYS = ['ca_google_token_v1','ca_google_token','ca_google_access_token'];

let accessToken = null;

function loadStoredToken(){
  try{
    for(const k of TOKEN_KEYS){
      const s = sessionStorage.getItem(k);
      if(s) return s;
      const l = localStorage.getItem(k);
      if(l) return l;
    }
  }catch(e){ console.warn('token load error',e); }
  return null;
}

function detectAuth(){
  accessToken = loadStoredToken();
  const pill = $$('globalAuthState');
  if(!pill) return;
  if(accessToken){
    pill.classList.add('ok');
    pill.classList.remove('bad');
    pill.innerHTML = 'âœ… Google ë¡œê·¸ì¸ í† í° ê°ì§€ë¨ (index.html)';
  }else{
    pill.classList.add('bad');
    pill.classList.remove('ok');
    pill.innerHTML = 'âš  index.htmlì—ì„œ ë¨¼ì € Google ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.';
  }
}

function requireAuth(){
  if(!accessToken){
    accessToken = loadStoredToken();
  }
  if(!accessToken){
    throw new Error('Google í† í°ì´ ì—†ìŠµë‹ˆë‹¤. index.htmlì—ì„œ ë¨¼ì € ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.');
  }
}

/* ========= Google API í˜¸ì¶œ ========= */
async function gFetch(url, init){
  requireAuth();
  const res = await fetch(url,{
    ...(init||{}),
    headers:{
      ...(init && init.headers || {}),
      Authorization:'Bearer '+accessToken,
      'Content-Type':'application/json'
    }
  });
  if(!res.ok){
    throw new Error(await res.text());
  }
  return res.json();
}

async function getRange(spreadsheetId, rangeA1){
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${encodeURIComponent(spreadsheetId)}/values/${encodeURIComponent(rangeA1)}`;
  return await gFetch(url);
}

async function batchUpdateValues(spreadsheetId, dataRanges){
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${encodeURIComponent(spreadsheetId)}/values:batchUpdate`;
  return await gFetch(url,{
    method:'POST',
    body:JSON.stringify({
      valueInputOption:'USER_ENTERED',
      data:dataRanges
    })
  });
}

/* ========= ì‹œíŠ¸ ëª©ë¡ (í´ë” + ìˆ˜ë™ ID ì¶”ê°€) ========= */
let FOLDER_SHEETS = []; // {id,name}
let MANUAL_SHEETS = []; // {id,name}

function currentSheetFiles(){
  return [...FOLDER_SHEETS, ...MANUAL_SHEETS];
}

async function loadTeacherFolderSheets(){
  try{
    txt('globalErr','');
    requireAuth();
    const q = `'${TEACHER_FOLDER_ID}' in parents and mimeType='application/vnd.google-apps.spreadsheet' and trashed=false`;
    const url = `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(q)}&fields=files(id,name)&orderBy=name`;
    const res = await fetch(url,{ headers:{ Authorization:'Bearer '+accessToken } });
    if(!res.ok) throw new Error(await res.text());
    const data = await res.json();
    FOLDER_SHEETS = (data.files||[]).map(f=>({id:f.id,name:f.name}));
    populateSheetSelect('A');
    populateSheetSelect('B');
  }catch(e){
    console.error(e);
    txt('globalErr','ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: '+(e.message||e));
  }
}

function populateSheetSelect(sfx){
  const sel     = byPanel('sheetSelect',sfx);
  const readSel = byPanel('readSheetSelect',sfx);
  if(!sel || !readSel) return;

  const prevSheetId = sel.value;
  const prevRead    = readSel.value;

  sel.innerHTML = '';
  readSel.innerHTML = '';

  const files = currentSheetFiles();
  if(!files.length){
    sel.appendChild(new Option('(ê°•ì‚¬ ê³µìœ ìš© ì‹œíŠ¸ í´ë”ì— ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—†ìŒ)',''));
    return;
  }

  sel.appendChild(new Option('ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì„ íƒ',''));
  files.forEach(f=>{
    const opt = new Option(f.name, f.id);
    sel.appendChild(opt);
  });

  // ì´ì „ ì„ íƒ ë³µì›
  if(prevSheetId){
    const o = [...sel.options].find(x=>x.value===prevSheetId);
    if(o) o.selected = true;
  }
  if(sel.value){
    onSheetChanged(sfx, prevRead);
  }
}

function extractSpreadsheetIdInput(input){
  const s = String(input||'').trim();
  if(!s) return '';
  const m = s.match(/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
  return m ? m[1] : s;
}

async function addManualSheet(){
  try{
    txt('globalErr','');
    const raw = val('manualSheetInput');
    const inputEl = $$('manualSheetInput');
    const sheetId = extractSpreadsheetIdInput(raw);
    if(!sheetId) throw new Error('ìŠ¤í”„ë ˆë“œì‹œíŠ¸ URL ë˜ëŠ” IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.');

    const url = `https://sheets.googleapis.com/v4/spreadsheets/${encodeURIComponent(sheetId)}?fields=properties(title)`;
    const data = await gFetch(url);
    const name = data.properties?.title || `ìˆ˜ë™ ì‹œíŠ¸ (${sheetId.slice(0,8)}...)`;
    MANUAL_SHEETS.push({id:sheetId, name});
    if(inputEl) inputEl.value = '';
    populateSheetSelect('A');
    populateSheetSelect('B');
  }catch(e){
    console.error(e);
    txt('globalErr','ìˆ˜ë™ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì¶”ê°€ ì‹¤íŒ¨: '+(e.message||e));
  }
}

async function listSheets(spreadsheetId){
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${encodeURIComponent(spreadsheetId)}?fields=sheets(properties(title))`;
  const data = await gFetch(url);
  return (data.sheets||[]).map(s => s.properties.title);
}

async function onSheetChanged(sfx, restoreRead){
  const sel     = byPanel('sheetSelect',sfx);
  const readSel = byPanel('readSheetSelect',sfx);
  const openBtn = byPanel('btnOpenSheet',sfx);
  if(!sel || !readSel) return;

  readSel.innerHTML = '';
  const sheetId = sel.value;
  if(!sheetId){
    if(openBtn) openBtn.disabled = true;
    return;
  }
  try{
    const titles = await listSheets(sheetId);
    readSel.appendChild(new Option('ì½ê¸° ì‹œíŠ¸ ì„ íƒ',''));
    titles.forEach(t => readSel.appendChild(new Option(t,t)));
    if(restoreRead){
      const o=[...readSel.options].find(x=>x.value===restoreRead);
      if(o) o.selected=true;
    }
    if(openBtn){
      openBtn.disabled = false;
      openBtn.onclick = () => {
        window.open(`https://docs.google.com/spreadsheets/d/${sheetId}/edit`,'_blank','noopener');
      };
    }
  }catch(e){
    console.error(e);
    txt('err','ì‹œíŠ¸ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: '+(e.message||e),sfx);
  }
}

/* ========= ì¹´ì¹´ì˜¤í†¡ ë¡œê·¸ íŒŒì¼ (ë¡œì»¬ + ë“œë¼ì´ë¸Œ) ========= */
const chatTextLocal = { A:'', B:'' };

function parseCsvColC(raw){
  const lines = raw.split(/\r?\n/);
  const colC  = [];
  for(let i=0;i<lines.length;i++){
    const line = lines[i];
    if(!line.trim()) continue;
    const cells = line.split(',');
    if(cells.length<3) continue;
    let cell = cells[2].trim();
    if(cell.startsWith('"') && cell.endsWith('"')){
      cell = cell.slice(1,-1);
    }
    if(cell) colC.push(cell);
  }
  return colC.join('\n');
}

async function onChatFileChange(e, sfx){
  const input = e.target;
  const file = input.files && input.files[0];
  const nameSpan = byPanel('chatFileName',sfx);
  if(!file){
    chatTextLocal[sfx] = '';
    if(nameSpan) nameSpan.textContent = 'ì„ íƒëœ íŒŒì¼ ì—†ìŒ';
    return;
  }
  try{
    let text = await file.text();
    if(file.name.toLowerCase().endsWith('.csv')){
      text = parseCsvColC(text);
    }
    chatTextLocal[sfx] = text;
    if(nameSpan) nameSpan.textContent = file.name;
  }catch(err){
    console.error(err);
    chatTextLocal[sfx] = '';
    if(nameSpan) nameSpan.textContent = 'íŒŒì¼ ì½ê¸° ì‹¤íŒ¨';
    txt('err','ì¹´ì¹´ì˜¤í†¡ íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: '+(err.message||err),sfx);
  }
}

/* === ë“œë¼ì´ë¸Œ txt/csv === */
let driveFolderId  = {A:null,B:null};
let driveFiles     = {A:[], B:[]};

function extractDriveFolderId(input){
  const s = String(input||'').trim();
  if(!s) return '';
  const m = s.match(/folders\/([a-zA-Z0-9_-]+)/);
  return m ? m[1] : s;
}

async function listDriveTxtFiles(folderId){
  requireAuth();
  const q = `'${folderId}' in parents and (mimeType='text/plain' or mimeType='text/csv') and trashed=false`;
  const url = `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(q)}&fields=files(id,name,modifiedTime,size)&orderBy=modifiedTime desc&pageSize=200`;
  const res = await fetch(url,{ headers:{ Authorization:'Bearer '+accessToken } });
  if(!res.ok) throw new Error(await res.text());
  const data = await res.json();
  return data.files || [];
}

async function getDriveFolderName(folderId){
  requireAuth();
  const url = `https://www.googleapis.com/drive/v3/files/${encodeURIComponent(folderId)}?fields=name`;
  const res = await fetch(url,{ headers:{ Authorization:'Bearer '+accessToken } });
  if(!res.ok) throw new Error(await res.text());
  const data = await res.json();
  return data.name || folderId;
}

async function pickDriveFolder(sfx){
  try{
    const input = prompt('êµ¬ê¸€ ë“œë¼ì´ë¸Œ í´ë” URL ë˜ëŠ” IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.','');
    if(!input) return;
    const id = extractDriveFolderId(input);
    if(!id) throw new Error('í´ë” IDë¥¼ ì¸ì‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    driveFolderId[sfx] = id;
    await refreshDriveList(sfx);
  }catch(e){
    console.error(e);
    txt('err','ë“œë¼ì´ë¸Œ í´ë” ì„¤ì • ì‹¤íŒ¨: '+(e.message||e),sfx);
  }
}

async function refreshDriveList(sfx){
  const sel   = byPanel('driveFileSelect',sfx);
  const label = byPanel('driveFolderLabel',sfx);
  driveFiles[sfx] = [];
  if(sel) sel.innerHTML = '';
  const folderId = driveFolderId[sfx];
  if(!folderId){
    if(label){
      label.textContent = 'í´ë” ë¯¸ì„¤ì •';
      label.classList.remove('connected');
    }
    if(sel) sel.appendChild(new Option('(ë“œë¼ì´ë¸Œ í´ë” ë¯¸ì„¤ì •)',''));
    return;
  }
  try{
    const files = await listDriveTxtFiles(folderId);
    driveFiles[sfx] = files.map((f,idx)=>({
      id:f.id,
      name:f.name,
      size:f.size || 0,
      mtime:f.modifiedTime ? Date.parse(f.modifiedTime) : 0
    }));
    if(label){
      try{
        const nm = await getDriveFolderName(folderId);
        label.textContent = nm;
      }catch(e){
        label.textContent = folderId;
      }
      label.classList.add('connected');
    }
    if(sel){
      sel.appendChild(new Option('í´ë” ë‚´ íŒŒì¼ ì„ íƒ',''));
      driveFiles[sfx].forEach((f,idx)=>{
        sel.appendChild(new Option(f.name, String(idx)));
      });
    }
  }catch(e){
    console.error(e);
    if(label){
      label.textContent = 'ë“œë¼ì´ë¸Œ ì ‘ê·¼ ì˜¤ë¥˜';
      label.classList.remove('connected');
    }
    if(sel) sel.appendChild(new Option('(ë“œë¼ì´ë¸Œ ì ‘ê·¼ ì˜¤ë¥˜)',''));
    txt('err','ë“œë¼ì´ë¸Œ íŒŒì¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: '+(e.message||e),sfx);
  }
}

async function readSelectedTxtFromDrive(sfx){
  const idxStr = val('driveFileSelect',sfx);
  if(!idxStr) throw new Error('ë“œë¼ì´ë¸Œ txt/csv íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.');
  const info = driveFiles[sfx][Number(idxStr)];
  if(!info) throw new Error('ì„ íƒí•œ íŒŒì¼ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

  requireAuth();
  const url = `https://www.googleapis.com/drive/v3/files/${encodeURIComponent(info.id)}?alt=media`;
  const res = await fetch(url,{ headers:{ Authorization:'Bearer '+accessToken } });
  if(!res.ok) throw new Error(await res.text());

  let raw = await res.text();
  if(info.name.toLowerCase().endsWith('.csv')){
    raw = parseCsvColC(raw);
  }
  return raw;
}

/* ========= ì¹´ì¹´ì˜¤í†¡ ë¡œê·¸ íŒŒì‹± ========= */
const JOIN_PAT  = /(.*?)ë‹˜ì´\s*(ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤|ë“¤ì–´ì™”ìŠµë‹ˆë‹¤|ì…ì¥í–ˆìŠµë‹ˆë‹¤|ë“¤ì–´ì˜¤ì…¨ìŠµë‹ˆë‹¤)[\s\.\!]*$/;
const LEAVE_PAT = /(.*?)ë‹˜ì´\s*(í‡´ì¥í•˜ì…¨ìŠµë‹ˆë‹¤|ë‚˜ê°”ìŠµë‹ˆë‹¤|í‡´ì¥í–ˆìŠµë‹ˆë‹¤|ë‚˜ê°€ì…¨ìŠµë‹ˆë‹¤)[\s\.\!]*$/;
const KICK_PAT  = /(.*?)ë‹˜ì„\s*(ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤|ê°•í‡´í–ˆìŠµë‹ˆë‹¤|ì¶”ë°©í–ˆìŠµë‹ˆë‹¤)[\s\.\!]*$/;

function splitNickname(nick){
  const raw = String(nick||'').trim();
  if(!raw) return null;
  const idx = raw.search(/\d/);
  let namePart = idx>=0 ? raw.slice(0,idx) : raw;
  let name = namePart.replace(/[/_\-\s]+$/,'');
  name = normalizeName(name);
  if(!name) return { name:raw, digits:null };
  const digitsAll = raw.replace(/[^\d]/g,'');
  const digits = digitsAll.length>=4 ? digitsAll.slice(-4) : null;
  return { name, digits };
}

function parseChat(text){
  const lines = text.split(/\r?\n/);
  const events = [];
  let joinedCount = 0, leftCount = 0;
  for(const raw of lines){
    const line = raw.trim();
    if(!line) continue;
    let m = line.match(JOIN_PAT);
    if(m){
      events.push({type:'join', nick:m[1].trim(), raw:line});
      joinedCount++;
      continue;
    }
    m = line.match(LEAVE_PAT);
    if(m){
      events.push({type:'leave', nick:m[1].trim(), raw:line});
      leftCount++;
      continue;
    }
    m = line.match(KICK_PAT);
    if(m){
      events.push({type:'leave', nick:m[1].trim(), raw:line});
      leftCount++;
      continue;
    }
  }
  return { events, joinedCount, leftCount };
}

/* ========= ì‹¤í–‰ ë¡œì§ ========= */
async function runMain(sfx){
  try{
    txt('err','',sfx);
    const resultsEl = byPanel('results',sfx);
    if(resultsEl) resultsEl.innerHTML = '';

    // 1ìˆœìœ„: ë“œë¼ì´ë¸Œ ì„ íƒ íŒŒì¼, 2ìˆœìœ„: ë¡œì»¬ ì—…ë¡œë“œ
    let chatText = '';
    const driveIdx = val('driveFileSelect',sfx);
    if(driveIdx){
      chatText = await readSelectedTxtFromDrive(sfx);
    }else if(chatTextLocal[sfx]){
      chatText = chatTextLocal[sfx];
    }

    if(!chatText) throw new Error('ì¹´ì¹´ì˜¤í†¡ ë‚´ë³´ë‚´ê¸° txt/csvë¥¼ ë¡œì»¬ ì—…ë¡œë“œí•˜ê±°ë‚˜ ë“œë¼ì´ë¸Œì—ì„œ ì„ íƒí•˜ì„¸ìš”.');

    const sheetSel = byPanel('sheetSelect',sfx);
    const readSel  = byPanel('readSheetSelect',sfx);
    if(!sheetSel || !sheetSel.value) throw new Error('ìŠ¤í”„ë ˆë“œì‹œíŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
    if(!readSel  || !readSel.value)  throw new Error('ì½ê¸° ì‹œíŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.');

    const spreadsheetId = sheetSel.value;
    const readSheet     = readSel.value;
    const writeSheet    = FIXED_WRITE_SHEET;
    const readCol       = READ_NAME_COL;

    const previewOnly = byPanel('previewOnly',sfx)?.checked;

    // ì¹´ì¹´ì˜¤í†¡ ì´ë²¤íŠ¸ íŒŒì‹±
    const { events, joinedCount, leftCount } = parseChat(chatText);

    const NAME_ONLY_SENTINEL = '__NAMEONLY__';
    const activeDigitsByName = new Map();
    const leftFinalDigitsByName = new Map();
    const nameOnlyJoin = new Set();
    const ensureSet = (map,key) => {
      if(!map.has(key)) map.set(key,new Set());
      return map.get(key);
    };

    for(const ev of events){
      const s = splitNickname(ev.nick);
      if(!s) continue;
      const nN = s.name;
      if(ev.type === 'join'){
        ensureSet(activeDigitsByName,nN).add(s.digits || NAME_ONLY_SENTINEL);
        if(leftFinalDigitsByName.has(nN)){
          const L = leftFinalDigitsByName.get(nN);
          L.delete(s.digits || NAME_ONLY_SENTINEL);
          if(L.size===0) leftFinalDigitsByName.delete(nN);
        }
        if(!s.digits) nameOnlyJoin.add(nN);
      }else{
        const A = ensureSet(activeDigitsByName,nN);
        if(s.digits) A.delete(s.digits);
        else if(A.size===1 && A.has(NAME_ONLY_SENTINEL)) A.delete(NAME_ONLY_SENTINEL);
        ensureSet(leftFinalDigitsByName,nN).add(s.digits || NAME_ONLY_SENTINEL);
      }
    }

    // ì½ê¸° ì‹œíŠ¸ì—ì„œ ëª…ë‹¨ ê°€ì ¸ì˜¤ê¸° (ì´ë¦„ ëª©ë¡)
    const readNames = await getRange(spreadsheetId, `${readSheet}!${readCol}${READ_START_ROW}:${readCol}`);
    const readRows  = readNames.values || [];

    const rosterNames   = [];
    const rosterNamesN  = [];
    const rosterSetN    = new Set();

    for(let i=0;i<readRows.length;i++){
      const nm = String(readRows[i]?.[0] ?? '').trim();
      if(!nm) continue;
      const nN = normalizeName(nm);
      rosterNames.push(nm);
      rosterNamesN.push(nN);
      rosterSetN.add(nN);
    }

    // ê³µìœ ìš© ì‹œíŠ¸ì—ì„œ ê¸°ì¡´ A~E (no, ?, ?, name, phone) ê°€ì ¸ì˜¤ê¸°
    const wAtoE = await getRange(spreadsheetId, `${writeSheet}!A${WRITE_START_ROW}:E`);
    const wRowsAE = wAtoE.values || [];

    const earliestByKey  = new Map(); // name|last4 â†’ {id,phoneFull,phone4}
    const earliestByName = new Map(); // nameN      â†’ {id,phoneFull,phone4}

    for(const r of wRowsAE){
      const id       = (r[0] ?? '').toString().trim();
      const nameRaw  = (r[3] ?? '').toString().trim();
      const phoneRaw = (r[4] ?? '').toString().trim();
      if(!id || !nameRaw) continue;
      const nN  = normalizeName(nameRaw);
      const p4  = last4Digits(phoneRaw);

      if(p4){
        const key = nN + '|' + p4;
        if(!earliestByKey.has(key)){
          earliestByKey.set(key,{id,phoneFull:phoneRaw,phone4:p4});
        }else{
          const cur = earliestByKey.get(key);
          earliestByKey.set(key, earlierId(cur.id,id)===cur.id ? cur : {id,phoneFull:phoneRaw,phone4:p4});
        }
      }

      if(!earliestByName.has(nN)){
        earliestByName.set(nN,{id,phoneFull:phoneRaw,phone4:p4});
      }else{
        const cur = earliestByName.get(nN);
        earliestByName.set(nN, earlierId(cur.id,id)===cur.id ? cur : {id,phoneFull:phoneRaw,phone4:p4});
      }
    }

    const isAttendingNameN = nN => {
      const set = activeDigitsByName.get(nN);
      return (set && set.size>0) || nameOnlyJoin.has(nN);
    };

    const attendingSetN = new Set(
      [...rosterSetN].filter(nN => isAttendingNameN(nN))
    );

    // ë¦¬í¬íŠ¸ìš©: ë‚´ ëª…ë‹¨ ê¸°ì¤€ ìƒíƒœ
    const report = [];
    for(let i=0;i<rosterNames.length;i++){
      const nm       = rosterNames[i];
      const nN       = rosterNamesN[i];
      const baseInfo = earliestByName.get(nN) || { phoneFull:'', phone4:'' };
      const phoneFull = baseInfo.phoneFull || '';
      const set       = activeDigitsByName.get(nN) || new Set();
      const any4      = [...set].find(x => x!==NAME_ONLY_SENTINEL) || '';
      const matchedId =
        any4 && earliestByKey.get(nN + '|' + any4) ? earliestByKey.get(nN + '|' + any4).id :
        earliestByName.get(nN)?.id || '';
      const notes  = (isAttendingNameN(nN) && !any4) ? '(ë²ˆí˜¸ì—†ìŒ)' : '';
      const status = attendingSetN.has(nN) ? 'ì…ì¥' : 'ë¯¸ì…ì¥';
      const rosterNo = matchedId;
      report.push([
        rosterNo,
        nm,
        phoneFull,
        status,
        any4 ? `${nm}/${any4}` : (status==='ì…ì¥'? nm : ''),
        notes
      ]);
    }

    // ëª…ë‹¨ ì™¸ ì…ì¥ì
    const extra = [];
    [...activeDigitsByName.entries()]
      .sort(([a],[b]) => a.localeCompare(b,'ko'))
      .forEach(([nN,set])=>{
        if(!rosterSetN.has(nN)){
          const digits = [...set].filter(x => x!==NAME_ONLY_SENTINEL);
          if(digits.length){
            digits.forEach(d => extra.push([`${nN}/${d}`]));
          }
          if(set.has(NAME_ONLY_SENTINEL)){
            extra.push([`${nN}(ë²ˆí˜¸ì—†ìŒ)`]);
          }
        }
      });

    // í‡´ì¥ì ëª…ë‹¨
    const leavers = [];
    [...leftFinalDigitsByName.entries()]
      .sort(([a],[b]) => a.localeCompare(b,'ko'))
      .forEach(([nN,set])=>{
        const activeSet = activeDigitsByName.get(nN);
        set.forEach(d=>{
          if(!activeSet || !activeSet.has(d)){
            if(d===NAME_ONLY_SENTINEL) leavers.push([`${nN}(ë²ˆí˜¸ì—†ìŒ)`]);
            else leavers.push([`${nN}/${d}`]);
          }
        });
      });

    // ê³µìœ ìš© ì‹œíŠ¸ì—ì„œ ì‹¤ì œ ê°±ì‹  ëŒ€ìƒ í–‰ ì°¾ê¸° (Tì—´ == ìˆ˜ê°•ìƒ)
    const readWriteRange = `${writeSheet}!D${WRITE_START_ROW}:T`;
    const wdata   = await getRange(spreadsheetId, readWriteRange);
    const rows    = wdata.values || [];
    const targetRowsIdx = [];
    const nameCountN    = new Map();

    for(let i=0;i<rows.length;i++){
      const r   = rows[i] || [];
      const tVal= (r[16] ?? '').toString().trim(); // Tì—´
      if(tVal !== 'ìˆ˜ê°•ìƒ') continue;
      const nameN = normalizeName(String(r[0] ?? '')); // Dì—´
      if(!nameN) continue;
      targetRowsIdx.push(i);
      nameCountN.set(nameN,(nameCountN.get(nameN)||0)+1);
    }

    const updates    = [];
    const unresolved = [];

    for(const i of targetRowsIdx){
      const r       = rows[i] || [];
      const nameRaw = String(r[0] ?? '').trim();
      const nameN   = normalizeName(nameRaw);
      const phone4  = last4Digits(r[1] ?? '');
      if(!nameN) continue;
      if(!attendingSetN.has(nameN)) continue;

      const set       = activeDigitsByName.get(nameN) || new Set();
      const isDupInPaid = (nameCountN.get(nameN)||0)>1;
      let canWrite    = false;

      if(isDupInPaid){
        if(phone4 && set.has(phone4)){
          canWrite = true;
        }else{
          if(set.has(NAME_ONLY_SENTINEL)){
            unresolved.push([nameRaw,'ê³µìœ ì‹œíŠ¸ ë™ëª…ì´ì¸ + ì…ì¥ë¡œê·¸ ë²ˆí˜¸ì—†ìŒ']);
          }else{
            unresolved.push([nameRaw,'ê³µìœ ì‹œíŠ¸ ë™ëª…ì´ì¸ + ë²ˆí˜¸ë¶ˆì¼ì¹˜']);
          }
        }
      }else{
        if(set.size>=1 || set.has(NAME_ONLY_SENTINEL)) canWrite = true;
      }

      if(canWrite){
        const rowNumber = WRITE_START_ROW + i;
        updates.push({
          range : `${writeSheet}!S${rowNumber}`,
          values: [['ì…ì¥']]
        });
      }
    }

    if(updates.length && !previewOnly){
      await batchUpdateValues(spreadsheetId, updates);
    }

    // ìƒë‹¨ pill ìš”ì•½
    const pills = $$('pills'+sfx+sfx);
    if(pills){
      pills.innerHTML = '';
      const mk = (t,c)=>{
        const s=document.createElement('span');
        s.className='pill '+c;
        s.textContent=t;
        return s;
      };
      pills.appendChild(mk(`ì…ì¥ë¡œê·¸ join ${joinedCount}`,'ok'));
      pills.appendChild(mk(`í‡´ì¥ë¡œê·¸ leave ${leftCount}`,'bad'));
      pills.appendChild(mk(`ì…ì¥ ëŒ€ìƒ(ì½ê¸° ì‹œíŠ¸) ${attendingSetN.size}`,'warn'));
      if(previewOnly) pills.appendChild(mk('ì²´í¬ë§Œ (ì‹¤ì œ ê¸°ë¡ ì—†ìŒ)','warn'));
    }

    // ê²°ê³¼ í…Œì´ë¸” ë Œë”ë§
    function resTbl(title, headers, rowsArr){
      if(!resultsEl) return;
      const wrap = document.createElement('div');
      wrap.className = 'card';
      const h = document.createElement('h3');
      h.textContent = title;
      h.style.margin = '0 0 8px';
      h.style.fontSize = '14px';
      wrap.appendChild(h);

      const scroll = document.createElement('div');
      scroll.className = 'table-scroll';

      const t = document.createElement('table');
      const thead = document.createElement('thead');
      const trh = document.createElement('tr');
      headers.forEach(x=>{
        const th=document.createElement('th');
        th.textContent=x;
        trh.appendChild(th);
      });
      thead.appendChild(trh);
      t.appendChild(thead);

      const tb = document.createElement('tbody');
      (rowsArr || []).forEach(r=>{
        const tr=document.createElement('tr');
        (r || []).forEach(c=>{
          const td=document.createElement('td');
          td.textContent = (c==null?'':String(c));
          tr.appendChild(td);
        });
        tb.appendChild(tr);
      });
      t.appendChild(tb);
      scroll.appendChild(t);
      wrap.appendChild(scroll);
      resultsEl.appendChild(wrap);
    }

    resTbl('ë‚´ ëª…ë‹¨ ê¸°ì¤€ ìƒíƒœ (ì½ê¸° ì‹œíŠ¸ ê¸°ì¤€)', ['no','name','phone','status','matched_id','notes'], report);
    resTbl('ëª…ë‹¨ ì™¸ ì…ì¥ì', ['name/last4 or (ë²ˆí˜¸ì—†ìŒ)'], extra);
    resTbl('í‡´ì¥ì ëª…ë‹¨(ìµœì¢…)', ['name/last4 or (ë²ˆí˜¸ì—†ìŒ)'], leavers);
    resTbl(previewOnly ? 'ì˜ˆìƒ ê°±ì‹  ê²°ê³¼ (ì²´í¬ë§Œ ëª¨ë“œ)' : 'ê³µìœ ìš© ì‹œíŠ¸ ê°±ì‹  ê²°ê³¼',
           ['updated_cells'],
           updates.map(u => [u.range + ' â† ì…ì¥']));
    resTbl('ë¯¸í™•ì¸ ëª©ë¡ (ê³µìœ  ì‹œíŠ¸ ë™ëª…ì´ì¸/ë²ˆí˜¸ ë¬¸ì œ)', ['name','reason'], unresolved);

  }catch(e){
    console.error(e);
    txt('err','ì˜¤ë¥˜: '+(e.message || e),sfx);
  }
}

/* ========= ë°ëª¨ ========= */
function runDemo(sfx){
  txt('err','',sfx);
  const resultsEl = byPanel('results',sfx);
  if(resultsEl) resultsEl.innerHTML = '';

  const roster = [
    {id:1,name:'í™©í˜„í•˜',phone:'010-1234-5678'},
    {id:3,name:'ê¹€í˜œì˜',phone:'010-3456-7890'},
    {id:4,name:'ì„ê·œë¦¬',phone:'010-1717-1771'},
    {id:5,name:'ê¹€ì˜ˆì€',phone:'010-1111-0000'},
    {id:6,name:'ë°©ì˜ˆì§„',phone:'010-0000-9999'},
  ];
  const rosterSetN = new Set(roster.map(r=>normalizeName(r.name)));

  const chatText = [
    'ê¹€ì˜ˆì€/0000ë‹˜ì´ ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤',
    'í™©í˜„í•˜/5678ë‹˜ì´ ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤',
    'ë°©ì˜ˆì§„/9999ë‹˜ì´ ì…ì¥í–ˆìŠµë‹ˆë‹¤',
    'ì„ê·œë¦¬ 1771ë‹˜ì´ ë“¤ì–´ì™”ìŠµë‹ˆë‹¤',
    'ê¹€í˜œì˜/7890ë‹˜ì´ ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤',
    'ì§„ì¢…ë²”/2514ë‹˜ì´ ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤',
    'ë§¤ë“œë“œë¼ì´ë²„ê¹€ì§€í˜„ë‹˜ì´ ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤',
    'ì„¸ê³„ì œì¼ì˜ê·œë¦¬ë‹¹ì¥ì°¬ì–‘ë‹˜ì´ ë‚˜ê°”ìŠµë‹ˆë‹¤.',
    'ì†¡ì§€í˜„ì˜ˆì˜ë‹¤ë‹˜ì„ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤.'
  ].join('\n');

  const { events, joinedCount, leftCount } = parseChat(chatText);

  const NAME_ONLY_SENTINEL = '__NAMEONLY__';
  const active  = new Map();
  const leftFin = new Map();
  const ensure = (map,key)=>{ if(!map.has(key)) map.set(key,new Set()); return map.get(key); };

  for(const ev of events){
    const s = splitNickname(ev.nick);
    if(!s) continue;
    const nN = s.name;
    if(ev.type==='join'){
      ensure(active,nN).add(s.digits||NAME_ONLY_SENTINEL);
      const L = leftFin.get(nN);
      if(L){
        L.delete(s.digits||NAME_ONLY_SENTINEL);
        if(L.size===0) leftFin.delete(nN);
      }
    }else{
      const A = ensure(active,nN);
      if(s.digits) A.delete(s.digits);
      else if(A.size===1 && A.has(NAME_ONLY_SENTINEL)) A.delete(NAME_ONLY_SENTINEL);
      ensure(leftFin,nN).add(s.digits||NAME_ONLY_SENTINEL);
    }
  }

  const paidRows = [
    {name:'ê¹€ì˜ˆì€',phone4:'0000'},
    {name:'ë°©ì˜ˆì§„',phone4:'9999'},
    {name:'í™©í˜„í•˜',phone4:'5678'},
    {name:'í™©í˜„í•˜',phone4:'9999'},
    {name:'ê¹€í˜œì˜',phone4:''},
  ];
  const paidNameCountN = new Map();
  for(const r of paidRows){
    const nN = normalizeName(r.name);
    paidNameCountN.set(nN,(paidNameCountN.get(nN)||0)+1);
  }

  const report = [];
  for(const r of roster){
    const nN  = normalizeName(r.name);
    const set = active.get(nN) || new Set();
    const isActive = set.size>0;
    const any4 = [...set].find(x=>x!==NAME_ONLY_SENTINEL) || '';
    report.push([
      String(r.id),
      r.name,
      r.phone,
      isActive ? 'ì…ì¥' : 'ë¯¸ì…ì¥',
      isActive ? (any4 ? `${r.name}/${any4}` : r.name) : '',
      isActive && !any4 ? '(ë²ˆí˜¸ì—†ìŒ)' : ''
    ]);
  }

  const extra = [];
  [...active.entries()].sort(([a],[b])=>a.localeCompare(b,'ko')).forEach(([nN,set])=>{
    if(!rosterSetN.has(nN)){
      const digits = [...set].filter(x=>x!==NAME_ONLY_SENTINEL);
      if(digits.length) digits.forEach(d=>extra.push([`${nN}/${d}`]));
      if(set.has(NAME_ONLY_SENTINEL)) extra.push([`${nN}(ë²ˆí˜¸ì—†ìŒ)`]);
    }
  });

  const leavers = [];
  [...leftFin.entries()].sort(([a],[b])=>a.localeCompare(b,'ko')).forEach(([nN,set])=>{
    const act = active.get(nN);
    set.forEach(d=>{
      if(!act || !act.has(d)){
        leavers.push([d===NAME_ONLY_SENTINEL?`${nN}(ë²ˆí˜¸ì—†ìŒ)`: `${nN}/${d}`]);
      }
    });
  });

  const unresolved = [];
  for(const r of paidRows){
    const nN = normalizeName(r.name);
    const set = active.get(nN) || new Set();
    const isDupInPaid = (paidNameCountN.get(nN)||0)>1;
    if(!isDupInPaid) continue;
    const p4 = (r.phone4 || '').trim();
    if(p4 && set.has(p4)) continue;
    unresolved.push([
      r.name,
      p4 ? 'ê³µìœ ì‹œíŠ¸ ë™ëª…ì´ì¸ + ë²ˆí˜¸ë¶ˆì¼ì¹˜' : 'ê³µìœ ì‹œíŠ¸ ë™ëª…ì´ì¸ + ì…ì¥ë¡œê·¸ ë²ˆí˜¸ì—†ìŒ'
    ]);
  }

  const pills = $$('pills'+sfx+sfx);
  if(pills){
    pills.innerHTML = '';
    const mk = (t,c)=>{const s=document.createElement('span');s.className='pill '+c;s.textContent=t;return s;};
    const attendingCount = roster.filter(r=>(active.get(normalizeName(r.name))||new Set()).size>0).length;
    pills.appendChild(mk(`ì…ì¥ë¡œê·¸ join ${joinedCount}`,'ok'));
    pills.appendChild(mk(`í‡´ì¥ë¡œê·¸ leave ${leftCount}`,'bad'));
    pills.appendChild(mk(`ì…ì¥ ëŒ€ìƒ(ë°ëª¨) ${attendingCount}`,'warn'));
    pills.appendChild(mk('ì²´í¬ë§Œ (ë°ëª¨)','warn'));
  }

  function resTbl(title, headers, rowsArr){
    if(!resultsEl) return;
    const wrap = document.createElement('div');
    wrap.className = 'card';
    const h = document.createElement('h3');
    h.textContent = title;
    h.style.margin = '0 0 8px';
    h.style.fontSize = '14px';
    wrap.appendChild(h);

    const scroll = document.createElement('div');
    scroll.className = 'table-scroll';

    const t = document.createElement('table');
    const thead = document.createElement('thead');
    const trh = document.createElement('tr');
    headers.forEach(x=>{
      const th=document.createElement('th');
      th.textContent=x;
      trh.appendChild(th);
    });
    thead.appendChild(trh);
    t.appendChild(thead);

    const tb = document.createElement('tbody');
    (rowsArr || []).forEach(r=>{
      const tr=document.createElement('tr');
      (r || []).forEach(c=>{
        const td=document.createElement('td');
        td.textContent = (c==null?'':String(c));
        tr.appendChild(td);
      });
      tb.appendChild(tr);
    });
    t.appendChild(tb);
    scroll.appendChild(t);
    wrap.appendChild(scroll);
    resultsEl.appendChild(wrap);
  }

  resTbl('ëª…ë‹¨ê¸°ì¤€ ì…ì¥ì(ë°ëª¨)', ['no','name','phone','status','matched_id','notes'], report);
  resTbl('ëª…ë‹¨ ì™¸ ì…ì¥ì(ë°ëª¨)', ['name/last4 or (ë²ˆí˜¸ì—†ìŒ)'], extra);
  resTbl('í‡´ì¥ì ëª…ë‹¨(ë°ëª¨)', ['name/last4 or (ë²ˆí˜¸ì—†ìŒ)'], leavers);
  resTbl('ë¯¸í™•ì¸ ëª©ë¡(ë°ëª¨)', ['name','reason'], unresolved);
}

/* ========= ì´ˆê¸°í™” ========= */
document.addEventListener('DOMContentLoaded', ()=>{
  detectAuth();
  loadTeacherFolderSheets();

  on('btnReloadSheets','click', loadTeacherFolderSheets);
  on('btnAddManualSheet','click', addManualSheet);

  // íŒ¨ë„ë³„ ì´ë²¤íŠ¸
  on('sheetSelect','change', ()=>onSheetChanged('A'), 'A');
  on('sheetSelect','change', ()=>onSheetChanged('B'), 'B');

  on('chatFileA','change', e=>onChatFileChange(e,'A'));
  on('chatFileB','change', e=>onChatFileChange(e,'B'));

  on('btnDriveFolder','click', ()=>pickDriveFolder('A'),'A');
  on('btnDriveFolder','click', ()=>pickDriveFolder('B'),'B');
  on('btnDriveRefresh','click', ()=>refreshDriveList('A'),'A');
  on('btnDriveRefresh','click', ()=>refreshDriveList('B'),'B');

  on('runBtn','click', ()=>runMain('A'),'A');
  on('runBtn','click', ()=>runMain('B'),'B');
  on('demoBtn','click',()=>runDemo('A'),'A');
  on('demoBtn','click',()=>runDemo('B'),'B');
});
</script>
</body>
</html>
